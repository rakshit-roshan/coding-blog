<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Tunnel - Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ”’</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-header {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        .input-focus-glow {
            transition: all 0.3s ease;
        }
        .input-focus-glow:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 0 20px rgba(99, 102, 241, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
        }
        .btn-secondary {
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
        }
        .loader-dots {
            animation: loader 1.4s infinite ease-in-out both;
        }
        .loader-dots:nth-child(1) { animation-delay: -0.32s; }
        .loader-dots:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loader {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .chat-container {
            height: calc(100vh - 140px);
        }
        .message-bubble {
            animation: messageSlide 0.3s ease-out;
        }
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .floating-animation {
                animation: none;
            }
            .glass-effect {
                backdrop-filter: blur(10px);
            }
            .btn-primary:hover, .btn-secondary:hover {
                transform: none;
            }
            .fixed.inset-0 .absolute {
                opacity: 0.02 !important;
            }
            .chat-container {
                height: calc(100vh - 120px);
            }
            .mobile-hidden {
                display: none !important;
            }
            .mobile-full {
                width: 100% !important;
            }
            .mobile-px-2 {
                padding-left: 8px;
                padding-right: 8px;
            }
            .mobile-py-1 {
                padding-top: 4px;
                padding-bottom: 4px;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 0;
            }
            .glass-effect {
                margin: 8px;
                padding: 12px;
            }
            .chat-container {
                height: calc(100vh - 100px);
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .btn-primary:hover, .btn-secondary:hover {
                transform: none;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Background decorative elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-10 left-10 w-72 h-72 bg-white opacity-5 rounded-full floating-animation"></div>
        <div class="absolute bottom-10 right-10 w-96 h-96 bg-white/5 rounded-full floating-animation" style="animation-delay: -3s;"></div>
        <div class="absolute top-1/2 left-1/4 w-32 h-32 bg-white opacity-10 rounded-full pulse-ring"></div>
    </div>

    <!-- Global Loader -->
    <div id="globalLoader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-700 hidden">
        <div class="glass-effect rounded-2xl p-8 shadow-2xl text-center">
            <div class="flex justify-center space-x-2 mb-6">
                <div class="w-3 h-3 bg-white rounded-full loader-dots"></div>
                <div class="w-3 h-3 bg-white rounded-full loader-dots"></div>
                <div class="w-3 h-3 bg-white rounded-full loader-dots"></div>
            </div>
            <div id="loaderText" class="text-xl font-semibold text-gray-800 mb-2">Loading...</div>
            <div id="loaderSubtext" class="text-gray-600 text-sm"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="w-full glass-header shadow-lg flex items-center justify-between px-4 md:px-8 py-3 md:py-4 relative z-10">
        <div class="flex items-center gap-2 md:gap-3">
            <div class="flex items-center justify-center w-6 h-6 md:w-8 md:h-8 bg-white rounded-lg shadow-md">
                <svg class="w-3 h-3 md:w-5 md:h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <span class="text-lg md:text-xl font-bold text-gray-800 tracking-tight">Secure Tunnel</span>
            <span class="hidden sm:inline text-sm text-gray-600" id="chatGroupName">â€¢ Chat</span>
        </div>
        <div class="flex items-center gap-2 md:gap-4">
            <span class="text-gray-700 font-medium text-sm md:text-base hidden sm:block" id="currentUserDisplay"></span>
            <button id="logoutBtn" class="px-2 py-1 md:px-4 md:py-2 rounded-lg bg-gray-100 text-gray-700 font-semibold hover:bg-indigo-50 transition-all duration-300 flex items-center gap-1 text-sm md:text-base">
                <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span class="hidden sm:inline">Logout</span>
            </button>
        </div>
    </header>

    <!-- Mobile Back Button -->
    <div class="md:hidden px-4 py-2">
        <button id="backToGroupsMobile" class="glass-effect px-4 py-2 rounded-lg text-indigo-600 font-semibold hover:bg-white/20 transition-all duration-300 flex items-center gap-2 shadow-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Groups
        </button>
    </div>

    <!-- Main Container -->
    <div class="px-2 md:px-8 pb-4 pt-[31px]">
        <div class="max-w-7xl mx-auto">
            <div class="flex gap-4 chat-container">
                <!-- Desktop Sidebar -->
                <aside class="hidden md:flex w-64 flex-col gap-4">
                    <!-- Back to Groups Button -->
                    <div class="glass-effect rounded-xl p-4 shadow-xl">
                        <button id="backToGroups" class="w-full py-3 px-4 border-2 border-indigo-600 text-indigo-600 font-semibold rounded-lg bg-white/80 hover:bg-indigo-600 hover:text-white btn-secondary transition-all duration-300 flex items-center justify-center gap-2">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        Back to Groups
                    </button>
                </div>

                <!-- Online Users -->
                <div class="glass-effect rounded-xl p-4 shadow-xl flex-1">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Online Users
                    </h3>
                    <ul id="onlineList" class="space-y-2 text-gray-700 text-sm"></ul>
                </div>
            </aside>

            <!-- Main Chat Area -->
            <main class="flex-1 glass-effect rounded-xl shadow-xl p-4 md:p-6 flex flex-col">
                <!-- Mobile Online Users Toggle -->
                <div class="md:hidden mb-4">
                    <button id="toggleOnlineUsers" class="px-3 py-1 bg-indigo-100 text-indigo-600 rounded-lg text-sm font-medium flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span id="onlineCount">0</span> Users Online
                    </button>
                    
                    <!-- Mobile Online Users Dropdown -->
                    <div id="mobileOnlineUsers" class="hidden mt-2 glass-effect rounded-lg p-3 shadow-lg">
                        <ul id="onlineListMobile" class="space-y-2 text-gray-700 text-sm"></ul>
                    </div>
                </div>

                <!-- Chat Messages Area -->
                <div id="chatMessages" class="flex-1 overflow-y-auto space-y-3 p-3 bg-gradient-to-b from-gray-50/50 to-white/50 rounded-lg border border-gray-200/50 mb-4 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100"></div>

                <!-- Message Input Form -->
                <form id="messageForm" class="flex gap-2 md:gap-3">
                    <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" 
                           class="flex-1 px-3 py-2.5 md:px-4 md:py-3 rounded-lg border border-gray-200 bg-white text-gray-900 text-sm md:text-base input-focus-glow focus:outline-none focus:border-indigo-500 transition-all duration-300" />
                    <button type="submit" class="px-4 py-2.5 md:px-6 md:py-3 btn-primary text-white font-semibold text-sm md:text-base rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        <span class="hidden sm:inline">Send</span>
                    </button>
                </form>
            </main>
        </div>
    </div>
</div>

<script>
    // --- Global variables for tracking state ---
let currentUser = null;
let selectedGroup = null;
let groupId = null;
let groupName = null;
let messageInterval = null;
let userInterval = null;
let lastMessageId = 0; // Track the ID of the last message displayed
let isScrolledToBottom = true; // Track scroll position

// --- Initial setup and session checks ---
// (Keep existing session checks for currentUser and selectedGroup)
try {
    currentUser = JSON.parse(localStorage.getItem('currentUser'));
    selectedGroup = JSON.parse(localStorage.getItem('selectedGroup'));
} catch {}

if (!currentUser || !currentUser.id) {
    window.location.href = 'index.html';
}
document.getElementById('currentUserDisplay').textContent = currentUser ? currentUser.username : '';

if (!selectedGroup || !selectedGroup.group_id) {
    window.location.href = 'group.html';
}
groupId = selectedGroup.group_id;
groupName = selectedGroup.group_name || 'Group Chat';
document.getElementById('chatGroupName').textContent = `â€¢ ${groupName}`;

// --- DOM Elements Initialization ---
const chatMessages = document.getElementById('chatMessages');
const messageForm = document.getElementById('messageForm');
const messageInput = document.getElementById('messageInput');
const onlineList = document.getElementById('onlineList');
const onlineListMobile = document.getElementById('onlineListMobile');
const onlineCount = document.getElementById('onlineCount');
const backToGroups = document.getElementById('backToGroups');
const backToGroupsMobile = document.getElementById('backToGroupsMobile');
const logoutBtn = document.getElementById('logoutBtn');
const toggleOnlineUsers = document.getElementById('toggleOnlineUsers');
const mobileOnlineUsers = document.getElementById('mobileOnlineUsers');

// --- Loader Functions ---
function showLoader(text = 'Loading...', subtext = '') { /* ... (keep existing loader functions) ... */ }
function hideLoader() { /* ... (keep existing loader functions) ... */ }

// --- Back to Groups Functionality ---
function goBackToGroups() {
    showLoader('Returning to Groups...', 'Loading your groups');
    stopAutoRefresh();
    setTimeout(() => {
        window.location.href = 'group.html';
    }, 800);
}
if (backToGroups) backToGroups.onclick = goBackToGroups;
if (backToGroupsMobile) backToGroupsMobile.onclick = goBackToGroups;

// --- Logout Functionality ---
if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('selectedGroup');
        stopAutoRefresh();
        window.location.href = 'index.html';
    });
}

// --- Mobile Online Users Toggle ---
if (toggleOnlineUsers) {
    toggleOnlineUsers.addEventListener('click', () => {
        mobileOnlineUsers.classList.toggle('hidden');
    });
}

// --- Fetch and Render Messages (Optimized) ---
async function fetchMessages() {
    if (!groupId) return;
    try {
        // Fetch messages only after the last fetched message ID
        const res = await fetch(`https://coding-blog-kdzv.onrender.com/api/groups/${groupId}/messages?since_id=${lastMessageId}`);
        
        if (!res.ok) {
            if (res.status === 404) { // API might return 404 if no new messages
                return; 
            }
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const newMessages = await res.json();
        
        if (newMessages.length > 0) {
            appendMessages(newMessages);
            // Update lastMessageId only if new messages were successfully processed and appended
            lastMessageId = newMessages[newMessages.length - 1].id;
        }
    } catch (error) {
        console.error('Error fetching messages:', error);
        if (chatMessages.innerHTML === '') { // Only show error if chat is empty
             showMessage('Could not load messages. Check connection or try refreshing.', 'error');
        }
    }
}

// --- Append new messages to the chat window ---
function appendMessages(messages) {
    if (!chatMessages) return;

    const currentScrollTop = chatMessages.scrollTop;
    const isScrolledToBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 50; // Allow a small buffer

    messages.forEach(msg => {
        const isMe = msg.user_id === currentUser.id;
        const bubbleColor = isMe ? 'bg-indigo-500 text-white' : `${getUserColor(msg.user_id)} text-gray-800`;
        const align = isMe ? 'items-end' : 'items-start';
        const textAlign = isMe ? 'text-right' : 'text-left';
        const bubbleAlign = isMe ? 'ml-auto' : 'mr-auto';
        const userLabel = isMe ? 'You' : (msg.username || msg.email || 'User');
        
        const bubble = document.createElement('div');
        bubble.className = `flex flex-col ${align} mb-3 message-bubble`;
        bubble.innerHTML = `
            <div class="text-xs text-gray-500 mb-1 ${textAlign} px-1 flex items-center gap-2">
                <span>${userLabel}</span>
                <span>â€¢</span>
                <span>${new Date(msg.created_at).toLocaleTimeString()}</span>
                ${isMe ? `<button class="delete-msg text-xs text-gray-400 hover:text-red-500 cursor-pointer transition-colors ml-2" data-id="${msg.id}" title="Delete message">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>` : ''}
            </div>
            <div class="px-4 py-3 rounded-2xl ${bubbleColor} max-w-xs md:max-w-md lg:max-w-lg ${bubbleAlign} shadow-sm border break-words">
                ${msg.content}
            </div>
        `;
        chatMessages.appendChild(bubble);
    });

    // Auto-scroll to bottom if user was already at bottom
    if (isScrolledToBottom) {
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    }

    // Re-attach delete event listeners for newly added messages
    chatMessages.querySelectorAll('.delete-msg').forEach(button => {
        button.addEventListener('click', async (e) => {
            e.preventDefault();
            const msgId = button.getAttribute('data-id');
            if (confirm('Delete this message?')) {
                try {
                    await fetch(`https://coding-blog-kdzv.onrender.com/api/messages/${msgId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: currentUser.id })
                    });
                    fetchMessages(); // Refresh messages after deletion
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showMessage('Failed to delete message', 'error');
                }
            }
        });
    });
}

// --- Send Message ---
if (messageForm) {
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content || !currentUser || !groupId) return;

        messageInput.disabled = true;
        const submitBtn = messageForm.querySelector('button[type="submit"]');
        const originalBtnContent = submitBtn.innerHTML;
        submitBtn.innerHTML = `<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>`;
        submitBtn.disabled = true;

        try {
            const response = await fetch(`https://coding-blog-kdzv.onrender.com/api/groups/${groupId}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUser.id, content })
            });
            
            if (!response.ok) {
                throw new Error('Failed to send message');
            }

            const sentMessage = await response.json();
            // Optimistically append the sent message immediately
            appendMessages([sentMessage]); 
            // Update lastMessageId with the ID of the message just sent
            lastMessageId = sentMessage.id; 

            messageInput.value = '';
        } catch (error) {
            console.error('Error sending message:', error);
            showMessage('Failed to send message', 'error');
        } finally {
            messageInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnContent;
            messageInput.focus();
        }
    });
}

// --- Fetch and Render Online Users ---
async function fetchOnlineUsers() {
    try {
        const res = await fetch(`https://coding-blog-kdzv.onrender.com/api/groups/${groupId}/members`);
        if (!res.ok) throw new Error('Failed to fetch members');
        const users = await res.json();
        renderOnlineUsers(users);
    } catch (error) {
        console.error('Error fetching online users:', error);
        // Fallback to showing only the current user if fetch fails
        renderOnlineUsers([{ 
            username: currentUser.username, 
            email: currentUser.email, 
            is_online: true 
        }]);
    }
}

function renderOnlineUsers(users) {
    const userCount = users.length || 1;
    if (onlineCount) onlineCount.textContent = userCount;

    const renderUserList = (container) => {
        if (!container) return;
        container.innerHTML = '';
        
        if (!users.length) {
            container.innerHTML = `
                <li class="flex items-center gap-3 p-2 rounded-lg bg-indigo-50">
                    <span class="inline-block w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="font-medium text-green-700">${currentUser.username}</span>
                    <span class="text-xs text-indigo-600">(You)</span>
                </li>
            `;
            return;
        }

        users.forEach(user => {
                const isCurrentUser = user.email === currentUser.email || user.username === currentUser.username;
                // Simulate online/offline status if not provided by API
                const isOnline = user.is_online !== undefined ? user.is_online : (Math.random() > 0.3); 
                const dotColor = isOnline ? 'bg-green-500' : 'bg-gray-400';
                const textColor = isOnline ? 'text-gray-700' : 'text-gray-500';
                const bgColor = isCurrentUser ? 'bg-indigo-50' : (isOnline ? 'bg-green-50' : 'bg-gray-50');
                
                container.innerHTML += `
                    <li class="flex items-center gap-3 p-2 rounded-lg ${bgColor} transition-colors">
                        <span class="inline-block w-3 h-3 rounded-full ${dotColor} ${isOnline ? 'animate-pulse' : ''}"></span>
                        <span class="font-medium ${textColor}">${user.username || user.email}</span>
                        ${isCurrentUser ? '<span class="text-xs text-indigo-600">(You)</span>' : ''}
                    </li>
                `;
            });
        };

        renderUserList(onlineList);
        renderUserList(onlineListMobile);
    }

    // --- Auto-refresh functionality ---
    function startAutoRefresh() {
        // Fetch messages every 2 seconds
        messageInterval = setInterval(fetchMessages, 2000);
        // Fetch users every 10 seconds
        userInterval = setInterval(fetchOnlineUsers, 10000);
    }

    function stopAutoRefresh() {
        if (messageInterval) clearInterval(messageInterval);
        if (userInterval) clearInterval(userInterval);
    }

    // --- Utility function for showing toast messages ---
    function showMessage(message, type) {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 
            type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // --- Keyboard shortcuts ---
    document.addEventListener('keydown', (e) => {
        // Escape to close mobile online users
        if (e.key === 'Escape' && mobileOnlineUsers && !mobileOnlineUsers.classList.contains('hidden')) {
            mobileOnlineUsers.classList.add('hidden');
        }
        
        // Alt + Enter for new line in message input
        if (e.altKey && e.key === 'Enter' && document.activeElement === messageInput) {
            e.preventDefault();
            const cursorPos = messageInput.selectionStart;
            const textBefore = messageInput.value.substring(0, cursorPos);
            const textAfter = messageInput.value.substring(cursorPos);
            messageInput.value = textBefore + '\n' + textAfter;
            messageInput.selectionStart = messageInput.selectionEnd = cursorPos + 1;
        }
        // Ctrl + Enter to send message
        if (e.ctrlKey && e.key === 'Enter' && document.activeElement === messageInput) {
            e.preventDefault();
            messageForm.requestSubmit();
        }
    });

    // --- Page visibility handling ---
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
            fetchMessages(); // Fetch immediately when tab becomes visible
            fetchOnlineUsers();
        }
    });

    // --- Window focus/blur handling ---
    window.addEventListener('focus', () => {
        fetchMessages();
        fetchOnlineUsers();
    });

    // --- Auto-focus message input ---
    setTimeout(() => {
        if (messageInput) messageInput.focus();
    }, 1000);

    // --- Initialize chat ---
    async function initializeChat() {
        showLoader('Entering the tunnel...', 'Loading your group chat');
        
        try {
            // Fetch initial data concurrently
            await Promise.all([
                fetchMessages(),
                fetchOnlineUsers()
            ]);
            
            startAutoRefresh();
            hideLoader();
            
            setTimeout(() => {
                showMessage(`Welcome to ${groupName}!`, 'success');
            }, 500);
            
        } catch (error) {
            hideLoader();
            showMessage('Failed to load chat. Please refresh the page.', 'error');
            console.error('Error initializing chat:', error);
        }
    }

    // --- Click outside to close mobile online users ---
    document.addEventListener('click', (e) => {
        if (toggleOnlineUsers && mobileOnlineUsers && 
            !toggleOnlineUsers.contains(e.target) && 
            !mobileOnlineUsers.contains(e.target)) 
        {
            mobileOnlineUsers.classList.add('hidden');
        }
    });

    // --- Enhanced error handling ---
    window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        hideLoader();
        showMessage('An unexpected error occurred. Please refresh the page.', 'error');
    });

    window.addEventListener('error', (event) => {
        console.error('JavaScript error:', event.error);
        hideLoader();
    });

    // --- Cleanup on page unload ---
    window.addEventListener('beforeunload', () => {
        stopAutoRefresh();
    });

    // --- Initial Data Fetch ---
    window.addEventListener('DOMContentLoaded', () => {
        // Set initial lastMessageId to 0 to fetch all messages on first load
        lastMessageId = 0; 
        initializeChat();
    });

    // --- Service Worker Registration (Optional) ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js') // Ensure you have a sw.js file
            .then(registration => {
                console.log('ServiceWorker registered with scope:', registration.scope);
            })
            .catch(error => {
                console.log('ServiceWorker registration failed:', error);
            });
    }

</script>
</body>
</html>